# 🏢 지점 관리자 기능 가이드

**버전:** 2.0  
**업데이트:** 2025년 12월 4일  
**작성자:** Offday 개발팀

---

## 📋 목차

1. [개요](#개요)
2. [새로운 역할 시스템](#새로운-역할-시스템)
3. [지점 관리자 지정 방법](#지점-관리자-지정-방법)
4. [지점 관리자 권한](#지점-관리자-권한)
5. [데이터베이스 업데이트](#데이터베이스-업데이트)
6. [사용 시나리오](#사용-시나리오)
7. [문제 해결](#문제-해결)

---

## 🎯 개요

### 기능 소개

**지점 관리자** 기능은 대규모 조직에서 각 지점의 연차 관리를 효율적으로 수행할 수 있도록 설계된 권한 시스템입니다.

### 핵심 가치

- ✅ **권한 분산**: 본사 관리자의 부담 감소
- ✅ **신속한 처리**: 지점별 자체 승인 가능
- ✅ **데이터 보안**: 지점별 데이터 격리
- ✅ **유연한 관리**: 지점별 맞춤 운영

---

## 🔐 새로운 역할 시스템

### 역할 구조

```
┌─────────────────────────────────────────┐
│           최고 관리자 (Admin)            │
│     ▪ 모든 권한                          │
│     ▪ 지점 관리자 지정                   │
│     ▪ 시스템 설정                        │
└───────────────┬─────────────────────────┘
                │
    ┌───────────┴──────────────┐
    │                          │
┌───▼─────────────┐    ┌───────▼──────────┐
│  매니저         │    │ 지점 관리자      │
│  (Manager)      │    │ (Branch Manager) │
│                 │    │                  │
│ ▪ 전체 조회     │    │ ▪ 지점 내 조회   │
│ ▪ 전체 승인     │    │ ▪ 지점 내 승인   │
│ ▪ 통계 관리     │    │ ▪ 지점 통계      │
└─────────────────┘    └──────────────────┘
         │                      │
         └──────────┬───────────┘
                    │
            ┌───────▼───────┐
            │   팀장        │
            │ (Team Leader) │
            │               │
            │ ▪ 팀 내 조회  │
            │ ▪ 팀 내 승인  │
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │  일반 사용자   │
            │   (User)      │
            │               │
            │ ▪ 연차 신청   │
            │ ▪ 본인 조회   │
            └───────────────┘
```

### 역할별 권한 비교

| 기능 | Admin | Manager | Branch Manager | Team Leader | User |
|------|-------|---------|----------------|-------------|------|
| 연차 신청 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 본인 연차 조회 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 전체 연차 조회 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 지점 연차 조회 | ✅ | ✅ | ✅ (자기 지점) | ❌ | ❌ |
| 팀 연차 조회 | ✅ | ✅ | ✅ (자기 지점) | ✅ (자기 팀) | ❌ |
| 전체 연차 승인 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 지점 연차 승인 | ✅ | ✅ | ✅ (자기 지점) | ❌ | ❌ |
| 팀 연차 승인 | ✅ | ✅ | ✅ (자기 지점) | ✅ (자기 팀) | ❌ |
| 직원 정보 수정 | ✅ | ✅ | ✅ (자기 지점) | ❌ | ❌ |
| 역할 변경 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 지점 관리자 지정 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 복지휴가 지급 | ✅ | ✅ | ✅ (자기 지점) | ❌ | ❌ |
| 통계 조회 | ✅ | ✅ | ✅ (자기 지점) | ✅ (자기 팀) | ❌ |

---

## 👤 지점 관리자 지정 방법

### 1️⃣ 관리자 로그인

먼저 **관리자 계정**으로 로그인합니다.

### 2️⃣ 직원 관리 페이지 접속

```
메인관리 → 직원관리
```

### 3️⃣ 지점 관리자로 지정할 직원 선택

![지점 관리자 지정 버튼](https://via.placeholder.com/600x200/667eea/ffffff?text=지점+관리자+지정+버튼)

1. 직원 목록에서 지정할 직원 찾기
2. 해당 직원의 액션 버튼 중 **방패 아이콘** (🛡️) 클릭

### 4️⃣ 역할 및 관리 지점 선택

**지점 관리자 지정 모달**이 나타나면:

```
┌────────────────────────────────────┐
│  🛡️ 지점 관리자 지정                │
├────────────────────────────────────┤
│                                    │
│  직원 정보: 김철수 (강남점 - 영업팀) │
│                                    │
│  역할 선택: [지점 관리자 ▼]         │
│                                    │
│  관리할 지점: [강남점 ▼]            │
│                                    │
│  ℹ️ 지점 관리자 권한:               │
│  - 해당 지점의 연차 신청 조회       │
│  - 해당 지점의 연차 승인/거절       │
│  - 해당 지점의 통계 조회            │
│                                    │
│         [취소]      [저장 ✓]       │
└────────────────────────────────────┘
```

1. **역할 선택**: "지점 관리자" 선택
2. **관리할 지점**: 관리할 지점 선택 (기본값: 직원의 현재 지점)
3. **저장** 버튼 클릭

### 5️⃣ 완료 확인

```
✅ 김철수님을 지점 관리자(강남점)로 지정했습니다.
```

직원 목록에서 역할이 **"지점 관리자 (강남점)"**로 표시됩니다.

---

## 🔑 지점 관리자 권한

### 📊 승인 페이지

지점 관리자가 승인 페이지에 접속하면:

```
┌─────────────────────────────────────────┐
│  📋 연차 승인 관리                       │
├─────────────────────────────────────────┤
│  🔍 검색: [        ]  지점: [강남점]    │ ← 자동 필터링
│  상태: [전체 ▼]  유형: [전체 ▼]         │
├─────────────────────────────────────────┤
│                                         │
│  ✓ 이영희  [대기중]  강남점  영업팀      │
│     기간: 2025-12-10 ~ 2025-12-12 (3일) │
│     [승인] [거부]                        │
│                                         │
│  ✓ 박민수  [대기중]  강남점  관리팀      │
│     기간: 2025-12-15 ~ 2025-12-15 (1일) │
│     [승인] [거부]                        │
│                                         │
│  ❌ 최수진  영등포점  영업팀             │ ← 다른 지점은 보이지 않음
│                                         │
└─────────────────────────────────────────┘
```

**특징:**
- ✅ 자신이 관리하는 지점의 연차만 표시
- ✅ 승인/거절 버튼 활성화
- ✅ 일괄 승인/거절 가능

### 👥 직원 관리 페이지

지점 관리자는 직원 관리 페이지에 접근할 수 없습니다.
(관리자와 매니저만 접근 가능)

### 📈 통계 페이지

지점 관리자가 통계 페이지에 접속하면:

```
┌─────────────────────────────────────────┐
│  📊 통계 및 분석 (강남점)                │
├─────────────────────────────────────────┤
│                                         │
│  📌 지점 현황                            │
│  ▪ 총 직원: 15명                        │
│  ▪ 재직 중: 14명                        │
│  ▪ 이번 달 연차 사용: 45일              │
│                                         │
│  📋 대기 중인 승인                       │
│  ▪ 연차 신청: 3건                       │
│  ▪ 복지휴가: 1건                        │
│                                         │
│  📈 월별 연차 사용 추이                  │
│  [차트: 강남점 데이터만 표시]            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 💾 데이터베이스 업데이트

### Supabase 스키마 업데이트

Supabase SQL Editor에서 다음 파일을 실행하세요:

```sql
-- 파일: supabase-branch-manager-update.sql
```

**실행 방법:**

1. Supabase 대시보드 접속
2. SQL Editor 메뉴 클릭
3. `supabase-branch-manager-update.sql` 파일 내용 복사
4. 붙여넣기 후 **RUN** 버튼 클릭

### 업데이트 내용

```sql
✅ users 테이블에 managed_branch 컬럼 추가
✅ branch_manager 역할 추가
✅ RLS 정책 업데이트
✅ 통계 뷰 및 권한 함수 생성
✅ 감사 로그 테이블 생성
```

### 롤백 (필요 시)

만약 문제가 발생하면 다음 명령으로 롤백할 수 있습니다:

```sql
-- managed_branch 컬럼 제거
ALTER TABLE users DROP COLUMN IF EXISTS managed_branch;

-- branch_manager 역할 제거
DELETE FROM roles WHERE name = 'branch_manager';

-- RLS 정책 제거
DROP POLICY IF EXISTS "Branch managers can view their branch employees" ON users;
DROP POLICY IF EXISTS "Branch managers can view their branch leave requests" ON leave_requests;
DROP POLICY IF EXISTS "Branch managers can update their branch leave requests" ON leave_requests;
```

---

## 📖 사용 시나리오

### 시나리오 1: 지점 관리자 지정

**상황:**
- 강남점에 새로운 관리자가 부임했습니다.
- 김철수 대리가 강남점의 연차 승인을 담당하게 되었습니다.

**단계:**

1. **관리자 로그인**
   ```
   사용자: admin@company.com
   비밀번호: admin123
   ```

2. **직원 관리 페이지 접속**
   ```
   메인관리 → 직원관리
   ```

3. **김철수 검색**
   ```
   검색창에 "김철수" 입력
   ```

4. **지점 관리자 지정**
   ```
   김철수의 액션 버튼 중 🛡️ 아이콘 클릭
   역할: "지점 관리자" 선택
   관리할 지점: "강남점" 선택
   [저장] 클릭
   ```

5. **확인**
   ```
   ✅ 김철수님을 지점 관리자(강남점)로 지정했습니다.
   ```

---

### 시나리오 2: 지점 관리자의 연차 승인

**상황:**
- 김철수(강남점 지점 관리자)가 로그인했습니다.
- 강남점 이영희 대리가 연차를 신청했습니다.

**단계:**

1. **지점 관리자 로그인**
   ```
   사용자: chulsu.kim@company.com
   비밀번호: ********
   ```

2. **승인 페이지 접속**
   ```
   메인관리 → 승인관리
   ```

3. **강남점 연차만 표시됨**
   ```
   ┌──────────────────────────────────┐
   │  이영희  [대기중]  강남점         │
   │  기간: 2025-12-10 ~ 2025-12-12   │
   │  사유: 가족 행사                 │
   │  [승인] [거부]                   │
   └──────────────────────────────────┘
   
   ※ 영등포점, 부산점 등 다른 지점은 보이지 않음
   ```

4. **승인 처리**
   ```
   [승인] 버튼 클릭
   ```

5. **완료**
   ```
   ✅ 이영희님의 연차 신청이 승인되었습니다.
   ```

---

### 시나리오 3: 역할 변경 (지점 관리자 → 일반 사용자)

**상황:**
- 김철수가 본사로 이동하게 되어 지점 관리자 권한을 해제해야 합니다.

**단계:**

1. **관리자 로그인**

2. **직원 관리 페이지 접속**

3. **김철수 검색 후 🛡️ 아이콘 클릭**

4. **역할 변경**
   ```
   역할: "일반 사용자" 선택
   [저장] 클릭
   ```

5. **확인**
   ```
   ✅ 김철수님의 역할을 일반 사용자로 변경했습니다.
   ```

---

## ❓ 문제 해결

### Q1. 지점 관리자 지정 버튼이 안 보여요

**원인:**
- 관리자(Admin) 계정이 아닙니다.

**해결:**
```
✅ 관리자 계정으로 로그인하세요.
✅ 본인의 역할을 확인하세요 (마이페이지 → 프로필)
```

---

### Q2. 지점 관리자인데 다른 지점 연차가 보여요

**원인:**
- 권한 설정이 제대로 적용되지 않았습니다.

**해결:**
```
1. 페이지 새로고침 (Ctrl + F5)
2. 로그아웃 후 다시 로그인
3. 브라우저 캐시 삭제
4. 관리자에게 역할 재설정 요청
```

---

### Q3. Supabase 업데이트 시 오류가 발생해요

**오류 예시:**
```
ERROR: column "managed_branch" already exists
```

**해결:**
```
✅ 이미 컬럼이 존재하는 경우입니다.
✅ 무시하고 다음 단계로 진행하세요.
✅ 또는 "IF NOT EXISTS" 구문 확인
```

---

### Q4. 지점 관리자가 승인 버튼을 눌러도 안 돼요

**원인:**
- Supabase RLS 정책이 적용되지 않았습니다.

**해결:**
```
1. Supabase SQL Editor에서 다음 실행:
   
   SELECT * FROM roles WHERE name = 'branch_manager';
   
   → 결과가 없으면 SQL 스크립트 재실행

2. RLS 정책 확인:
   
   SELECT policyname FROM pg_policies 
   WHERE tablename = 'leave_requests';
   
   → "Branch managers can update..." 정책 확인
```

---

### Q5. 역할 변경 로그를 확인하고 싶어요

**방법:**

Supabase SQL Editor에서:

```sql
SELECT 
    user_id,
    old_role,
    new_role,
    old_managed_branch,
    new_managed_branch,
    changed_by,
    changed_at,
    reason
FROM role_change_logs
ORDER BY changed_at DESC
LIMIT 50;
```

---

## 📞 지원

### 기술 지원

**이메일:** support@offday-system.com  
**전화:** 02-1234-5678  
**운영 시간:** 평일 09:00 - 18:00

### 추가 문서

- [RBAC 완전 가이드](RBAC_COMPLETE.md)
- [Supabase 통합 가이드](INTEGRATION_GUIDE.md)
- [빠른 시작 가이드](QUICK_START.md)

---

## 📝 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|-----------|
| 2.0 | 2025-12-04 | 지점 관리자 기능 추가 |
| 1.5 | 2025-12-03 | Supabase 통합 완료 |
| 1.0 | 2025-12-01 | 초기 버전 |

---

**© 2025 Offday Management System. All rights reserved.**

